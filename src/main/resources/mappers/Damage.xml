<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.DamageMapper">
	<select id="findLatestByManagecode" parameterType="int"
		resultType="map">
		select dmgins.inscode,
			   dmgins.managecode,
			  (dmgins.crackcnt * cons.crack) as crack,
			  (dmgins.elecleakcnt * cons.elecleak) as elecleak,
			  (dmgins.leakcnt * cons.leak) as leak,
			  (dmgins.variationcnt * cons.variation) as variation,
			  (dmgins.abnormalitycnt * cons.abnormality) as abnormality,
			  dmgins.ins_date,
			  dmgins.inspactor
		from
			(select *
			 from damage_inspect
			 where managecode = #{managecode}
			 ORDER BY inscode DESC
			 LIMIT 1) dmgins
		left join constimp cons on dmgins.managecode = cons.managecode
	</select>
	
	<insert id="saveInspect">
		INSERT INTO damage_inspect (inscode, managecode, crackcnt, elecleakcnt, leakcnt, variationcnt, abnormalitycnt, ins_date, inspactor)
		VALUES (nextval('damage_inscode_seq'), #{managecode}, #{crackcnt}, #{elecleakcnt}, #{leakcnt}, #{variationcnt}, #{abnormalitycnt}, #{ins_date}, #{inspactor})
	</insert>
	
	
	<select id="getFindByInscode" parameterType="int" resultType="Damage_InspectDto">
		select dmgins.inscode,
			   dmgins.managecode,
			   dmgins.crackcnt,
			   dmgins.elecleakcnt,
			   dmgins.leakcnt,
			   dmgins.variationcnt,
			   dmgins.abnormalitycnt,
			  (dmgins.crackcnt * cons.crack) as crack,
			  (dmgins.elecleakcnt * cons.elecleak) as elecleak,
			  (dmgins.leakcnt * cons.leak) as leak,
			  (dmgins.variationcnt * cons.variation) as variation,
			  (dmgins.abnormalitycnt * cons.abnormality) as abnormality,
			  dmgins.ins_date,
			  dmgins.inspactor
		from
			(select *
			 from damage_inspect
			 where inscode = #{value}
			 ) dmgins
		left join constimp cons on dmgins.managecode = cons.managecode
	</select>
		
	<select id="getDamageHistory" parameterType="int" resultType="map">
		SELECT 
		    dmg.ins_date,
		    (dmg.crackcnt       * cons.crack)       AS crack,
		    (dmg.elecleakcnt    * cons.elecleak)    AS elecleak,
		    (dmg.leakcnt        * cons.leak)        AS leak,
		    (dmg.variationcnt   * cons.variation)   AS variation,
		    (dmg.abnormalitycnt * cons.abnormality) AS abnormality
		FROM damage_inspect dmg
		LEFT JOIN constimp cons ON dmg.managecode = cons.managecode
		WHERE dmg.managecode = #{managecode}
		ORDER BY dmg.ins_date
	</select>

	<!-- 이미지 저장 -->
    <insert id="saveDamageImg" parameterType="DamageImgDto">
        INSERT INTO damage_img (inscode, managecode, img_loc, filename)
        VALUES (#{inscode}, #{managecode}, #{img_loc}, #{filename})
    </insert>
	
	<!-- 이미지 조회 -->
    <select id="findImagesByInscode" parameterType="int"
            resultType="DamageImgDto">
        SELECT inscode,
               managecode,
               img_loc,
               filename
        FROM damage_img
        WHERE inscode = #{inscode}
        ORDER BY img_loc
    </select>
	


</mapper>