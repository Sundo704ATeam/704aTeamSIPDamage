<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.DamageMapper">
	<select id="findLatestByManagecode" parameterType="int"
		resultType="map">
		select dmgins.inscode,
			   dmgins.managecode,
			  (dmgins.crackcnt * cons.crack) as crack,
			  (dmgins.elecleakcnt * cons.elecleak) as elecleak,
			  (dmgins.leakcnt * cons.leak) as leak,
			  (dmgins.variationcnt * cons.variation) as variation,
			  (dmgins.abnormalitycnt * cons.abnormality) as abnormality,
			  dmgins.ins_date,
			  dmgins.inspactor
		from
			(select *
			 from damage_inspect
			 where managecode = #{managecode}
			 ORDER BY ins_date DESC
			 LIMIT 1) dmgins
		left join constimp cons on dmgins.managecode = cons.managecode
	</select>
	
	<insert id="saveInspect">
		INSERT INTO damage_inspect (inscode, managecode, crackcnt, elecleakcnt, leakcnt, variationcnt, abnormalitycnt, ins_date, inspactor)
		VALUES (nextval('damage_inscode_seq'), #{managecode}, #{crackcnt}, #{elecleakcnt}, #{leakcnt}, #{variationcnt}, #{abnormalitycnt}, #{ins_date}, #{inspactor})
	</insert>
	
	
	<select id="getFindByInscode" parameterType="int" resultType="Damage_InspectDto">
		select dmgins.inscode,
			   dmgins.managecode,
			   dmgins.crackcnt,
			   dmgins.elecleakcnt,
			   dmgins.leakcnt,
			   dmgins.variationcnt,
			   dmgins.abnormalitycnt,
			  (dmgins.crackcnt * cons.crack) as crack,
			  (dmgins.elecleakcnt * cons.elecleak) as elecleak,
			  (dmgins.leakcnt * cons.leak) as leak,
			  (dmgins.variationcnt * cons.variation) as variation,
			  (dmgins.abnormalitycnt * cons.abnormality) as abnormality,
			  dmgins.ins_date,
			  dmgins.inspactor
		from
			(select *
			 from damage_inspect
			 where inscode = #{value}
			 ORDER BY ins_date DESC
			 LIMIT 1) dmgins
		left join constimp cons on dmgins.managecode = cons.managecode
	</select>
		
	<select id="getDamageHistory" parameterType="int" resultType="map">
	  SELECT 
	    ins_date,
	    crackcnt   AS crackCnt,
	    elecleakcnt AS elecLeakCnt,
	    leakcnt     AS leakCnt,
	    variationcnt AS variationCnt,
	    abnormalitycnt AS abnormalityCnt
	  FROM damage_inspect
	  WHERE managecode = #{managecode}
	  ORDER BY ins_date
	</select>

	


</mapper>